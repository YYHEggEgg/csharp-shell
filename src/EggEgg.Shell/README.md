## 命令行参数传递原则（开发人员）

程序使用类 Microsoft C/C++ 代码使用的命令行分析规则（为了方便解释，我们同样将返回值称为 `argv`）。下面是一组 `CommandHandlerBase.ParseAsArgs`_（`ICommandHandler.cs:`）_ 命令行参数分析结果的例子：

| 命令行输入 | argv[0] | argv[1] | argv[2] |
| :----------- | :----------- | :----------- | :----------- |
| `"abc" d e` | `abc` | `d` | `e` |
| `a\\b d"e f"g h` | `a\\b` | `de fg` | `h` |
| `a\\\"b c d` | `a\"b` | `c` | `d` |
| `a\\\\"b c" d e` | `a\\b c` | `d` | `e` |
| `a"b"" c d` | `ab" c d` |  |  |
| `a"b"\" c d` | `ab"` | `c` | `d` |
| `ab\n cd` | `ab\n` | `cd` |  |

具体规则如下：

- 参数用空白分隔，空白可以是一个空格或制表符。

- 与应用至系统的算法不同，并不对 `argv[0]` 作特殊处理，因为其与 `CommandLine` 的 dispatcher 天然不兼容。

- 将双引号括起来的字符串解释为单个参数，哪怕其中可能包含空格字符。带引号的字符串可以嵌入在自变量内。未将插入点 (`^`) 识别为转义字符或者分隔符。在带引号的字符串中，一对双引号被解释为单个转义的双引号。如果命令行结束时未发现后双引号，则到目前为止读取的所有字符将输出为最后一个参数。  
  未成对的引号会被直接忽略，并将后续读取的所有字符视为为最后一个参数；不同的是该引号会被忽略，如样例 5（标准算法应输出 `ab" c d`）。如果期望其正常工作应为 `"` 添加反斜杠转义，例如样例 6.

- 前面有反斜杠的双引号 (`\"`) 被解释为原义双引号 (`"`)。

- 如果偶数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中，而双引号 (`"`) 被解释为字符串分隔符。

- 如果奇数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中。将双引号解释为包含 remaining 反斜杠的转义序列，导致将原义双引号 (`"`) 置于 `argv` 中。

## 附录 1：`CommandHandlerBase.ParseAsArgs` 编写原则

该方法通过 ChatGPT 生成。prompt 如下：

```md
请编写一个 C# 方法 `string[] ParseAsArgs(string cmd)`，输入一段字符串，模拟控制台的形式将其转换为控制台参数数组 `string[] argv`。以顶级语句格式编写，即代码仅包含开头的 using 与顶级方法声明与主体。

注意：不可省略任何代码逻辑。不可以使用命令行相关的 nuget 程序包（因为它们的行为方式可能与上述规则不同）。

你编写的代码需要遵循如下 Microsoft C/C++ 代码使用的命令行分析规则（为了方便解释，我们同样将返回值称为 `argv`）：

- 参数用空白分隔，空白可以是一个空格或制表符。

- 将双引号括起来的字符串解释为单个参数，哪怕其中可能包含空格字符。 带引号的字符串可以嵌入在自变量内。 未将插入点 (`^`) 识别为转义字符或者分隔符。 在带引号的字符串中，一对双引号被解释为单个转义的双引号。 如果命令行结束时未发现后双引号，则到目前为止读取的所有字符 将输出为最后一个参数。

- 前面有反斜杠的双引号 (`\"`) 被解释为原义双引号 (`"`)。

- 反斜杠按其原义解释，除非它们紧位于双引号之前。

- 如果偶数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中，而双引号 (`"`) 被解释为字符串分隔符。

- 如果奇数个反斜杠后跟双引号，则每对反斜杠 (`\\`) 中有一个反斜杠 (`\`) 被置于 `argv` 数组中。 将双引号解释为包含 remaining 反斜杠的转义序列，导致将原义双引号 (`"`) 置于 `argv` 中。

下示样例表显示了示例输入和预期输出，演示了前面列表中的规则。

| 命令行输入 | argv[1] | argv[2] | argv[3] |
| :----------- | :----------- | :----------- | :----------- |
| `"abc" d e` | `abc` | `d` | `e` |
| `a\\b d"e f"g h` | `a\\b` | `de fg` | `h` |
| `a\\\"b c d` | `a\"b` | `c` | `d` |
| `a\\\\"b c" d e` | `a\\b c` | `d` | `e` |
| `a"b"" c d` | `ab" c d` |  |  |
```

_注：EggEgg.Shell 使用的代码通过了所有样例。详情请参见 [单元测试定义](../EggEgg.Shell.Tests/CommandHandlerBaseTests.cs)_